---
title: "Validation Summary"
author: "Antoine Ricouard"
date: "`r Sys.Date()`"
output: html_document
---

```{r,echo=F}
print(paste("start: ",Sys.time()))
```

# Introduction {.tabset}

This script summarises the skill assessment of the model in an aggregated way, over year, species, fleets quantities and metrics. It provides synthetic figures such as heat maps and radar plots. 

It is necessary to run the previous .Rmd files (named validation_period..._step...) before running this one.

The document is organised in 3 main tabs, one for the preparation consisting in loading and processing data, one for analysis by fleets and one for the analysis by species. Inside these tabs, the reader will find skill assessment for the different versions of the model, measured by different metrics.


## Preparation
Before starting, we load necessary packages and the file containing all the functions we need:
```{r setup, message=F, warnings = F}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(latex2exp)
library(tidyr)
library(purrr, include.only = c("map_dfr"))
library(here)
library(doBy, include.only = c("which.minn"))
library(doParallel)
library(scales)
library(RColorBrewer)
library(stringr)
library(readr)
library(fmsb)
library(ggradar)
library(forcats)

import::here(.from = magrittr, "%>%", extract, extract2)
import::here(.from = purrr, imap_chr, imap_dfc)


source(paste0(here(),"/R_fun/model_validation_fun.R"))

```



First, we specify the path of the comparison and observation dataset storage:
```{r}
comp_data_path <- paste0(here(),"/Comparison_data")
obs_data_path <- paste0(here(),"/reference_data")
```

And the path to save figures:
```{r}
save_heatmaps_path <- paste0(here(),"/saved_plots/heatmaps")
save_radar_path <- paste0(here(),"/saved_plots/radar")
```
We also specify the time period on which the model is validated:
```{r}
years1 <- 2015:2018
years2 <- 2019:2022
```

The list of species:
```{r}
Species <- c("Solea_solea",
             "Lophius_piscatorius",
             "Lepidorhombus_whiffiagonis",
             "Raja_clavata",
             "Leucoraja_naevus",
             "Nephrops_norvegicus",
             "Merluccius_merluccius")
```

The list of fleet groups:
```{r}
fleet_groups <- c("inf12","sup12","foreign")
```

Let us make the list of successive versions of the model (names of **Comparison_data** sub-repertories)
to be taken into account:
```{r}
mod <- c("step1_TF0q1",
         "step2a_TF0q2_season",
         "step2b_TF1q1_metier",
         "step3a_TF1q2_all",
         "step3b_TF1q2_all")
```

Then the list of successive runs (names of **Comparison_data** sub-repertories):
```{r}
runs <- c("seq_2015_2018",
          "seq_2019_2022")

```


And list of skill assessment quantities (names of **Comparison_data** sub-repertories)
to be taken into account in the anaysis by speies:
```{r}
qty <- c("abundance_group",
         "catch_group",
         "catch_total",
         "catchN_group",
         "catchN_total",
         "F_group",
         "land_country",
         "land_metier",
         "land_metier_season",
         "land_season",
         "ssb",
         "total_abundance",
         "total_land")
```

Among these quantities, some are observed, the other ones are the result of a model estimation:
```{r}
qty_obs <-  c("catch_group",
              "catch_total",
              "catchN_group",
              "catchN_total",
              "land_country",
              "land_metier",
              "land_metier_season",
              "land_season",
              "total_land")
qty_mod <-  c("abundance_group",
              "F_group",
              "ssb",
              "total_abundance")

```

We do the same for the analysis by fleet:
```{r}
qty_fleet <- c("land_metier_fleet",
               "land_metier_season_fleet",
               "land_season_fleet",
               "land_species_fleet",
               "land_species_season_fleet")

```



If necessary, let us concatenate all comparison data sets, by quantity, across years and species (or fleets):
```{r,warning=FALSE,message=FALSE}
new_conc <- T
if(new_conc){
  data_concatenation(mod_list = mod,
                     run_list = runs,
                     qty_list = qty,
                     species_list = Species,
                     path = comp_data_path)
}

new_conc_flt <- T
if(new_conc_flt){
  data_concatenation_flt(mod_list = mod,
                         run_list = runs,
                         qty_list = qty_fleet,
                         fleet_group_list = fleet_groups,
                         path = comp_data_path)
}
```



Let us build a global summary dataset for period-wise simulations, by species:
```{r}
Data_byperiod <-  skills_summary(mod_list = mod,
                                 run_list = runs[grepl("seq",runs)],
                                 qty_list = qty,
                                 path = comp_data_path,
                                 by_period=T)
```

And by fleet (removing fleets 'other' because they are very minor):
```{r,warning=FALSE,message=FALSE}
Data_byfleet_byperiod <- skills_summary(mod_list = mod,
                                        run_list = runs[grepl("seq",runs)],
                                        qty_list = qty_fleet,
                                        path = comp_data_path,
                                        by_fleet = T,
                                        by_period= T) %>%
  fleet_translation(rm_fleets = c('other-12-15 missing',
                                  'other-15-18 missing',
                                  'other-18-24 missing',
                                  'other-24-40 missing',
                                  'other-80-Inf missing'))
```


## Summary figures by species by period{.tabset}
### AE {.tabset}
#### Heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "AE",
                                     thresh=c(-0.7,-0.3,0,0.3,0.7),
                                     sym=T)
  print(plot)
  save_last_heatmaps(name = paste0("AE_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = F)
}

```

##### Improvement
```{r}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "AE",
                                         from = plan$from[i],
                                         to = plan$to[i])
  print(plot)
}

```





### RwMSE {.tabset}
#### heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "RwMSE",
                                     thresh=c(0.1,0.3,0.5,0.7,0.9))
  print(plot)
  save_last_heatmaps(name = paste0("RwMSE_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = F)
}

```

##### Improvement
```{r}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "RwMSE",
                                         from = plan$from[i],
                                         to = plan$to[i])
  print(plot)
}

```




### r {.tabset}
#### heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "r",
                                     thresh=c(0,0.2,0.4,0.6,0.8))
  print(plot)
  save_last_heatmaps(name = paste0("r_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = F)
}

```

##### Improvement
```{r}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "r",
                                         from = plan$from[i],
                                         to = plan$to[i])
  print(plot)
}

```





### MEF {.tabset}
#### heatmaps by model step (forced recruitment) {.tabset}
##### Score
```{r}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "MEF",
                                     thresh=c(0,0.2,0.4,0.6,0.8))
  print(plot)
  save_last_heatmaps(name = paste0("MEF_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = F)
}

```

##### Improvement
```{r}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "MEF",
                                         from = plan$from[i],
                                         to = plan$to[i])
  print(plot)
}

```





### Multi-metrics synthesis{.tabset}
#### Forced recruitment
```{r}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_radar_synthesis_spp(data,
                                   w_ratio = 1,
                                   low_var = qty_mod, 
                                   high_var = qty_obs)
  print(this_mod)
  print(plot)
  save_last_radar(name = paste0("spp_w1_",this_mod),
                  path = save_radar_path,
                  by_fleet = F)
  
  plot <- plot_radar_synthesis_spp(data,
                                   w_ratio = 10,
                                   low_var = qty_mod, 
                                   high_var = qty_obs)
  print(this_mod)
  print(plot)
  save_last_radar(name = paste0("spp_w10_",this_mod),
                  path = save_radar_path,
                  by_fleet = F)
  
}

```



## Summary figures by fleet by period{.tabset}
Plot the list of fleets with respective weight in landings:
```{r}
fleet_weight_data <- fleet_weight(fleet_group_list = c("sup12","foreign","inf12"),
                                  path = obs_data_path,
                                  years=2015:2022,
                                  rm_fleets = c('other-12-15 missing',
                                                'other-15-18 missing',
                                                'other-18-24 missing',
                                                'other-24-40 missing',
                                                'other-80-Inf missing',
                                                'ES-0-10'))
fl_order <- fleet_weight_data$fleet_isis

plot_fleet_weight(fleet_weight_data)
save_last(name = "fleet_weight",
          path = paste0(save_heatmaps_path,"/by_fleet/"),
          h = 2700)
```

### AE {.tabset}
#### Heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r fig.width=7, fig.height=8}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byfleet_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "AE",
                                     thresh=c(-0.7,-0.3,0,0.3,0.7),
                                     by_fleet = T,
                                     sym=T,
                                     fleet_order=fl_order)
  print(plot)
  save_last_heatmaps(name = paste0("AE_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = T)
}

```

##### Improvement
```{r fig.width=7, fig.height=8}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byfleet_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "AE",
                                         from = plan$from[i],
                                         to = plan$to[i],
                                         thresh = c(-0.1,0,0.1,0.2),
                                         by_fleet = T,
                                         fleet_order=fl_order)
  print(plot)
}

```



### RwMSE {.tabset}
#### heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r fig.width=7, fig.height=8}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byfleet_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "RwMSE",
                                     thresh=c(0.1,0.3,0.5,0.7,0.9),
                                     by_fleet = T,
                                     fleet_order=fl_order)
  print(plot)
  save_last_heatmaps(name = paste0("RwMSE_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = T)
}

```

##### Improvement
```{r fig.width=7, fig.height=8}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byfleet_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "RwMSE",
                                         from = plan$from[i],
                                         to = plan$to[i],
                                         thresh = c(-0.1,0,0.1,0.2),
                                         by_fleet = T,
                                         fleet_order=fl_order)
  print(plot)
}

```






### r {.tabset}
#### heatmaps by model step (forced recruitment){.tabset}
##### Score
```{r fig.width=7, fig.height=8}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byfleet_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "r",
                                     thresh=c(0,0.2,0.4,0.6,0.8),
                                     by_fleet = T,
                                     fleet_order=fl_order)
  print(plot)
  save_last_heatmaps(name = paste0("r_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = T)
}

```

##### Improvement
```{r fig.width=7, fig.height=8}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byfleet_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "r",
                                         from = plan$from[i],
                                         to = plan$to[i],
                                         by_fleet = T,
                                         fleet_order=fl_order)
  print(plot)
}

```

### MEF {.tabset}
#### heatmaps by model step (forced recruitment) {.tabset}
##### Score
```{r fig.width=7, fig.height=8}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byfleet_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_heatmap_thresh_period(data,
                                     metrics = "MEF",
                                     by_fleet = T,
                                     thresh = c(0,0.2,0.4,0.6,0.8),
                                     fleet_order=fl_order)
  print(plot)
  save_last_heatmaps(name = paste0("MEF_",this_mod),
                   path = save_heatmaps_path,
                   by_fleet = T)
}

```

##### Improvement
```{r fig.width=7, fig.height=8}
plan <- data.frame(from = c(rep("step1_TF0q1",4),
                            "step2a_TF0q2_season",
                            "step2b_TF1q1_metier"),
                   to = c("step2a_TF0q2_season",
                          "step2b_TF1q1_metier",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all",
                          "step3a_TF1q2_all",
                          "step3b_TF1q2_all"))

for(i in seq(nrow(plan))){
  data <- Data_byfleet_byperiod %>% filter(!SR)
  plot <- plot_heatmap_imp_thresh_period(data,
                                         metrics = "MEF",
                                         from = plan$from[i],
                                         to = plan$to[i],
                                         by_fleet = T,
                                         fleet_order=fl_order)
  print(plot)
}

```






### Multi-metrics synthesis{.tabset}
#### Forced recruitment
```{r fig.width=7}
for(m in seq(length(mod))){
  this_mod <- mod[m]
  data <- Data_byfleet_byperiod %>% filter(mod==this_mod & !SR)
  plot <- plot_radar_synthesis_fleet(data,
                                     w_ratio = 1,
                                     low_var = qty_mod, 
                                     high_var = qty_obs)
  print(this_mod)
  
  print(plot[[1]])
  save_last_radar(name = paste0("flt_inf12_",this_mod),
                  path = save_radar_path,
                  by_fleet = T)
  
  print(plot[[3]])
  save_last_radar(name = paste0("flt_foreign_",this_mod),
                  path = save_radar_path,
                  by_fleet = T)
  print(plot[[4]])
  save_last_radar(name = paste0("flt_grp_",this_mod),
                  path = save_radar_path,
                  by_fleet = T)
  
  print(plot[[9]])
  save_last_radar(name = paste0("flt_sup12_",this_mod),
                  path = save_radar_path,
                  by_fleet = T)
  
}

```



# .
```{r,echo=F}
print(paste("end: ",Sys.time()))
```